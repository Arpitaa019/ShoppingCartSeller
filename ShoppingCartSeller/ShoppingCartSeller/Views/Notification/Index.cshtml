@model List<ShoppingCartSeller.DTO.Notification.SellerNotificationModel>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Notification Bell -->
<div id="notificationIcon" class="position-fixed top-0 end-0 p-3" style="z-index:1050; cursor:pointer;" title="View Notifications">
    <div class="position-relative" style="width:40px; height:40px;">
        <div class="d-flex justify-content-center align-items-center rounded-circle border bg-light shadow-sm" style="width:100%; height:100%;">
            <i class="bi bi-bell-fill fs-4 text-primary"></i>
        </div>
        <span id="notificationDot" class="position-absolute bg-danger d-none" style="top:-2px; right:-2px; width:12px; height:12px; border-radius:50%; border:2px solid #fff; animation:pulse 1.5s infinite;"></span>
    </div>
</div>

<!-- Toast Popup -->
<div id="notificationPopup" class="toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 300px;">
    <div class="d-flex">
        <div class="toast-body" id="popupMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
</div>

<!-- Notification List -->
<h3 class="text-center text-secondary mt-3 mb-4">All Notifications</h3>
<div id="notificationArea" class="container mb-5">
    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">No notifications found.</div>
    }
    else
    {
        <ul class="list-group shadow-sm">
            @foreach (var note in Model)
            {
                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <span class="mark-read fw-semibold text-dark" data-id="@note.Id" style="cursor:pointer;">@note.Message</span>
                        <span class="badge @(note.IsRead ? "bg-success" : "bg-warning text-dark") ms-2">@((note.IsRead ? "Read" : "Unread"))</span>
                    </div>
                    <small class="text-muted">@note.CreatedAt.ToString("g")</small>
                </li>
            }
        </ul>
    }
</div>

<!-- Styles -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
@@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
}
.toast.show {
    animation: fadeIn 0.5s ease-in-out;
}
@@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let lastSeenId = 0;

    function showPopup(msg) {
        $('#popupMessage').text(msg);
        $('#notificationPopup').removeClass('d-none').addClass('show');
        $('#notificationDot').removeClass('d-none')
    }

    function hidePopup() {
        $('#notificationPopup').removeClass('show').addClass('d-none');
    }

    function updateRedDot() {
        const hasUnread = $('.badge.bg-warning').length > 0;
        $('#notificationDot').toggleClass('d-none', !hasUnread);
    }

    $(document).on('click', '.mark-read', function () {
        const id = $(this).data('id');
        const $badge = $(this).siblings('.badge');

        $.post('/Notification/MarkAsRead', { id }, () => {
            $badge.removeClass('bg-warning text-dark').addClass('bg-success').text('Read');
            updateRedDot();
        });
    });

    $('#notificationIcon').on('click', function () {
        $('html, body').animate({
            scrollTop: $('#notificationArea').offset().top
        }, 600);
    });

    setInterval(function () {
        $.ajax({
            url: '/Notification/CheckNewNotification',
            type: 'GET',
            data: { userId: 'testuser', lastSeenId: lastSeenId },
            success: function (data) {
                if (data.hasNew && !$(`[data-id="${data.id}"]`).length) {
                    lastSeenId = data.id;
                    sessionStorage.setItem('latestNotification', JSON.stringify(data));
                    showPopup(data.message);
                    $('#notificationDot').removeClass('d-none');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }, 5000);

    $(function () {
        const saved = sessionStorage.getItem('latestNotification');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data?.id && !$(`[data-id="${data.id}"]`).length) {
                    lastSeenId = data.id;
                    $('#notificationArea ul').prepend(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="mark-read text-dark fw-semibold" data-id="${data.id}" style="cursor:pointer;">${data.message}</span>
                                <span class="badge bg-warning text-dark ms-2">Unread</span>
                            </div>
                            <small class="text-muted">${data.createdAt ?? ''}</small>
                        </li>
                    `);
                    sessionStorage.removeItem('latestNotification');
                }
            } catch (e) {
                console.warn('Parse error:', e);
            }
        }
        updateRedDot();
    });
</script>